<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Component Overview | plgd</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Secure and Interoperable Internet of Things">
    
    <link rel="preload" href="/assets/css/0.styles.6d18922d.css" as="style"><link rel="preload" href="/assets/js/app.b9719399.js" as="script"><link rel="preload" href="/assets/js/2.e0060528.js" as="script"><link rel="preload" href="/assets/js/10.e2ff43d9.js" as="script"><link rel="prefetch" href="/assets/js/11.2fb98707.js"><link rel="prefetch" href="/assets/js/12.3ac77ce7.js"><link rel="prefetch" href="/assets/js/13.2360ab40.js"><link rel="prefetch" href="/assets/js/14.c4576077.js"><link rel="prefetch" href="/assets/js/15.0d973565.js"><link rel="prefetch" href="/assets/js/16.22cfc59c.js"><link rel="prefetch" href="/assets/js/17.0a7aecf6.js"><link rel="prefetch" href="/assets/js/18.7a323492.js"><link rel="prefetch" href="/assets/js/19.e2408cf2.js"><link rel="prefetch" href="/assets/js/20.bdf42c62.js"><link rel="prefetch" href="/assets/js/21.b8cdc876.js"><link rel="prefetch" href="/assets/js/22.7b9d62cb.js"><link rel="prefetch" href="/assets/js/23.3616b3be.js"><link rel="prefetch" href="/assets/js/24.3c36a4e8.js"><link rel="prefetch" href="/assets/js/25.8c14d9fe.js"><link rel="prefetch" href="/assets/js/26.54aef082.js"><link rel="prefetch" href="/assets/js/27.07ab084e.js"><link rel="prefetch" href="/assets/js/28.4599805b.js"><link rel="prefetch" href="/assets/js/29.4e859b9d.js"><link rel="prefetch" href="/assets/js/3.ea5d28bc.js"><link rel="prefetch" href="/assets/js/4.a40a2fc0.js"><link rel="prefetch" href="/assets/js/5.4d493bce.js"><link rel="prefetch" href="/assets/js/6.6d64bc1f.js"><link rel="prefetch" href="/assets/js/7.d405cf6f.js"><link rel="prefetch" href="/assets/js/8.0ce0d58d.js"><link rel="prefetch" href="/assets/js/9.6b51459b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d18922d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo-long.svg" alt="plgd" class="logo"> <span class="site-name can-hide">plgd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://gitter.im/ocfcloud/Lobby" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat with us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/plgd-dev/cloud/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/plgd-dev/cloud" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://gitter.im/ocfcloud/Lobby" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat with us
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/plgd-dev/cloud/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Changelog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/plgd-dev/cloud" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Getting Started</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Architecture</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/architecture/domain-overview.html" class="sidebar-link">Domain Overview</a></li><li><a href="/guide/architecture/system-overview.html" class="sidebar-link">System Overview</a></li><li><a href="/guide/architecture/component-overview.html" aria-current="page" class="active sidebar-link">Component Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#coap-gateway" class="sidebar-link">CoAP Gateway</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#grpc-gateway" class="sidebar-link">gRPC Gateway</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#http-gateway" class="sidebar-link">HTTP Gateway</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#resource-aggregate" class="sidebar-link">Resource Aggregate</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#resource-directory" class="sidebar-link">Resource Directory</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#device" class="sidebar-link">Device</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#client" class="sidebar-link">Client</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#event-bus" class="sidebar-link">Event Bus</a></li><li class="sidebar-sub-header"><a href="/guide/architecture/component-overview.html#event-store" class="sidebar-link">Event Store</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deployment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developing with plgd</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="component-overview"><a href="#component-overview" class="header-anchor">#</a> Component Overview</h1> <h2 id="coap-gateway"><a href="#coap-gateway" class="header-anchor">#</a> CoAP Gateway</h2> <p>The CoAP gateway acts as a CoAP Client, communicating with IoT devices - CoAP Servers following the <a href="https://openconnectivity.org/developer/specifications/" target="_blank" rel="noopener noreferrer">OCF specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. As the component diagram describes, responsibilities of the gateway are:</p> <ul><li>handle and maintain TCP connections comming from devices</li> <li>forward <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=15" target="_blank" rel="noopener noreferrer">authentication and authorization requests (see 5.5.5)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  to the Authorization Service</li> <li>process device CRUDN operations which are by its nature forwarded to the <a href="#resource-aggregate">Resource Aggregate</a> or <a href="#resource-directory">Resource Directory</a></li></ul> <details class="custom-block details"><summary>CoAP Gateway Component Diagram</summary> <p><img src="/img/diagrams/component-coapgateway.svg" alt="L3" width="600"></p></details> <p>OCF Servers / Clients communicate over TCP / UDP using the CoAP application protocol. Communication within the OCF Native Cloud shouldn't be restricted to the CoAP protocol, implementation should allow the use of whatever protocol might be introduced in the future. That's why the gateway is the access point for CoAP over TCP, and further communication is OCF Native Cloud specific.</p> <p>TCP connection to the OCF Native Cloud is by its nature stateful. The OCF CoAP Gateway is therefore also stateful, keeping open connections to the OCF Servers / Clients.  The goal of the Gateway is to translate between the OCF Servers / Clients (CoAP) and the protocol of the OCF Native Cloud and communicate in an asynchronous way.</p> <h3 id="validation"><a href="#validation" class="header-anchor">#</a> Validation</h3> <ul><li>OCF CoAP Gateway can accept requests from the OCF Client / Server only after a successful sign-in</li> <li>OCF CoAP Gateway can forward requests to the OCF Client / Server only after successful sign-in</li> <li>If sign-in was not issued within the configured amount of time or sign-in request failed, OCF Native Cloud will forcibly close the TCP connection</li> <li>OCF CoAP Gateway sends command to update device core resource with its status.
<ul><li>Online when the device was successfully signed-in and communication lock released</li> <li>Offline when the device was disconnected or signed-out</li></ul></li> <li>Access Token from a successful sign-in must be locally persisted in the OCF CoAP Gateway and linked with an opened TCP channel</li> <li>Access Token linked with the opened TCP channel has to be included in each command issued to other OCF Native Cloud components</li> <li>OCF CoAP Gateway processes only those commands, which are designated for a device which the Gateway has an opened TCP channel to</li> <li>OCF CoAP Gateway is observing each resource published to the resource directory and publishes an event for every change</li> <li>OCF CoAP Gateway retrieves each published resource and updates Resources</li> <li>OCF CoAP Gateway has to expose the coap ping-pong + retry count configuration, which can be configured during the deployment</li> <li>OCF CoAP Gateway has to ping the device in the configured time, if pong is not received after the configured number of retries, then the connection with the device is closed and device is set as offline</li> <li>OCF CoAP Gateway processes events from Resources, by issuing a proper CoAP request to the device and raising an event with the response</li> <li>OCF CoAP Gateway has to process a waiting request within the configured time, or set the device as offline</li></ul> <h3 id="apis"><a href="#apis" class="header-anchor">#</a> APIs</h3> <p>CoAP APIs of the Cloud Service are defined in <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.3.pdf" target="_blank" rel="noopener noreferrer">OCF Device To Cloud Services Specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <ul><li>POST /oic/sec/account - sign up the device with authorization code</li> <li>DELETE /oic/sec/account - sign off the device with access token</li> <li>POST /oic/sec/tokenrefresh - refresh access token with refresh token</li> <li>POST /oic/sec/session - sign in the device with access token and with login true</li> <li>POST /oic/sec/session - sign out the device with access token and with login false</li> <li>POST /oic/rd - publish resources from the signed device</li> <li>DELETE /oic/rd - unpublish resources from the signed device</li> <li>GET /oic/res - discover all cloud devices resources from the signed device</li> <li>GET /oic/route/{deviceID}/{href} - get/observe resource of the cloud device from signed device</li> <li>POST /oic/route/{deviceID}/{href} - update resource of the cloud device from signed device</li> <li>DELETE /oic/route/{deviceID}/{href} - delete resource of the cloud device from signed device</li></ul> <h3 id="operational-flow"><a href="#operational-flow" class="header-anchor">#</a> Operational flow</h3> <p>Before a device becomes operational and is able to interact with other devices, it needs to be appropriately onboarded. The first step in onboarding the device is to <a href="https://openconnectivity.org/specs/OCF_Security_Specification_v2.2.1.pdf#page=38" target="_blank" rel="noopener noreferrer">configure the ownership (see 5.3.3)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> where the legitimate user that owns/purchases the device uses an Onboarding tool (OBT) and using the OBT uses one of the Owner Transfer Methods (OTMs) to establish ownership. Once ownership is established, the OBT <a href="https://openconnectivity.org/specs/OCF_Security_Specification_v2.2.1.pdf#page=39" target="_blank" rel="noopener noreferrer">provisions the device (see 5.3.4)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, at the end of which the device can be <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=32" target="_blank" rel="noopener noreferrer">provisioned for the plgd.cloud (see 8.1.2.3)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. After successful provisioning, the device should <a href="https://openconnectivity.org/specs/OCF_Cloud_Security_Specification_v2.2.1.pdf#page=14" target="_blank" rel="noopener noreferrer">establish the TLS connection (see 7.2)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using the certificate based credentials.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Use <a href="https://github.com/plgd-dev/sdk" target="_blank" rel="noopener noreferrer">plgd.ocfclient<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or sample <a href="https://apps.apple.com/us/app/plgd/id1536315811" target="_blank" rel="noopener noreferrer">Apple<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://play.google.com/store/apps/details?id=dev.plgd.client" target="_blank" rel="noopener noreferrer">Android<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> mobile app for <strong>easy</strong> device discovery, ownership configuration and provisioning for the plgd.cloud!</p></div> <h4 id="device-onboarding"><a href="#device-onboarding" class="header-anchor">#</a> Device Onboarding</h4> <br> <img src="https://www.plantuml.com/plantuml/svg/ZPAnRW8n38RtF8N5YdW11WIzQw7JdGHIXquXPpXBHtno4YWL3zyag2fHXpQZ_y-__ITPEg_5XzEWUkeG3in-pnzAZR5AXaPjFTIW7KngF9F1IQ5KwxUiLRngOQqzNlIr95RR3Ao2xrdeKtjY2rkKCqe9Da-xJ3PsprewiaVOCGyJfP8ocotUvr2JCnmxeSkxE7MxtLITnDG-XmqAmYleapeAXn6QwWL-_1J4ayqMCT9qEeVd67u_aElX7WwQYqN9dA0FOky5rzC8-CrYzzke5JwJYz7IsWvD4F9NC6mFT0oIGp-wbdWmCOexX46XxHushmOENS7-CTZaXc9gdEWuYC7_Zg-JTthMydvsLPkCBPgSPHdH-6U-0000" alt="Sequence"> <p>TCP connection which device established to the CoAP Gateway is now authenticated but not authorized. Before the devices becomes reachable, TCP connection needs to be authorized. As this flow describes operation of a new device, device needs within the first connection Sign Up - <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=33" target="_blank" rel="noopener noreferrer">register with the plgd.cloud (see 8.1.4)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank" rel="noopener noreferrer">authorization code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> received during the OCF Cloud Provisioning process described in the diagram above is be by the CoAP Gateway exchanged for an access and refresh token and returned back to the device. This process is in more detail described in the <a href="https://openconnectivity.org/specs/OCF_Cloud_Security_Specification_v2.2.1.pdf#page=12" target="_blank" rel="noopener noreferrer">OCF Cloud Security Specification (see 6.2)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="cloud-registration"><a href="#cloud-registration" class="header-anchor">#</a> Cloud Registration</h4> <br> <img src="https://www.plantuml.com/plantuml/svg/ZP4zRyCW48PtViKfKwiqLjKnGnLajnvJsVrOkb1ynYWfM0Vaex--GEB1KeUoSVVUynul6-S5-V2zPuFk47fh_PSzCJR6gfPw5CP31SB1eiA3bhYOTShw8_TAor-W5XwFuZnNy3OBUF239VqZlBO6MgG3qbpOy2niqDb04e4hHQWYSi5O1Ql7xBLShg7Loi3Ro1JPCC8saH-AUvWxb3O-fgO4VjxR8uDu4Y1ouaO9ytIIWp0AGSm6fSqf40WfqJdmTeScZyUvFBs6ToJTd_zmp3f27yZ0TlTfRlW5yfeWTz1WJ-Y6wLeKnIr3qx7hOZ61j5Y3IZkF15qEFF8kYR0hUEfZDrLI8jX16F_bo3RHCtxuBm00" alt="Sequence"> <p>Successful registration to the plgd.dev is followed by authorization request called Sign In. Sign In is required right after sucessfully established TCP connection to the CoAP Gateway, otherwise the device won't be reachable - marked as online. Other device requests are blocked as well unless the device successfully Signs In. Successful autorization precedes validation of the <a href="https://tools.ietf.org/html/rfc6749#section-1.4" target="_blank" rel="noopener noreferrer">Access Token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="device-authorization"><a href="#device-authorization" class="header-anchor">#</a> Device Authorization</h4> <br> <img src="https://www.plantuml.com/plantuml/svg/LO_F3i8W3CRlVOfcryKNsC6CZ6JnPjJe6Q4Y4M41vf-t5z2OxDIqtw_Vr_OnYP3ckuMhKOGNxzFPlm2cF3NIJC8bv2WYDfmUHbApK8RnLBN1iosE8j5Jl9V4ZbLWHz7FGH8ohGFfJ3O075VhQj6s7UwDThXnKFhlkCEZi4Pb5fcK52CU_8t-H7OkUvoa5O5GrVDAc7VME890QGxkLwezgH80FJcL7_u0" alt="Sequence"> <p>Device capabilities are represented in form of resources. Configuration if the resource is published (remotely accessible over plgd.cloud) or not is part of the <a href="https://github.com/iotivity/iotivity-lite/blob/master/include/oc_cloud.h#L128" target="_blank" rel="noopener noreferrer">IoTivity-Lite API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. If the resource is publised or not is up to the device vendor which might want to have some resources accessible only on the proximity network. Resources information which are published to the plgd.cloud provides insights into device capabilities. Clients are interested not only in the resource href - location on which they can request resource representation, but mainly in the resource type as this allows them to filter only capabilities they are able to control.<br>
As an example, if you have an client application which controls the light, it will search the Resource Directory for all lights user have at home - filter resources by resource type <code>oic.r.switch.binary</code>. Other resources like temperature, moisture, etc. are not of any interest, as application doesn't understand their representation.<br>
Information which is published doesn't contain resource representation, only resource information as described <a href="https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.0.pdf#page=21" target="_blank" rel="noopener noreferrer">here (see 6.1.3.2.2)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <details class="custom-block details"><summary>Resource Publish Payload</summary> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
   <span class="token property">&quot;di&quot;</span><span class="token operator">:</span><span class="token string">&quot;e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9&quot;</span><span class="token punctuation">,</span>
   <span class="token property">&quot;links&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
         <span class="token property">&quot;anchor&quot;</span><span class="token operator">:</span><span class="token string">&quot;ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;href&quot;</span><span class="token operator">:</span><span class="token string">&quot;/myLightSwitch&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;rt&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">&quot;oic.r.switch.binary&quot;</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token property">&quot;if&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token string">&quot;oic.if.a&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;oic.if.baseline&quot;</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token property">&quot;p&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;bm&quot;</span><span class="token operator">:</span><span class="token number">3</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;eps&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
               <span class="token property">&quot;ep&quot;</span><span class="token operator">:</span><span class="token string">&quot;coaps://[fe80::b1d6]:1111&quot;</span><span class="token punctuation">,</span>
               <span class="token property">&quot;pri&quot;</span><span class="token operator">:</span><span class="token number">2</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
               <span class="token property">&quot;ep&quot;</span><span class="token operator">:</span><span class="token string">&quot;coaps://[fe80::b1d6]:1122&quot;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span><span class="token number">600476</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p>Resource publish request is forwarded to the <a href="#resource-aggregate">Resource Aggregate</a> which registers a new resource. This process makes the resource discoverable.<br>
The plgd.cloud starts observation of <strong>every successfuly published resource</strong> by sending the <a href="https://tools.ietf.org/html/rfc7641#section-1.2" target="_blank" rel="noopener noreferrer">OBSERVE request<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Each of the received notification from the device is send to the <a href="#resource-aggregate">Resource Aggregate</a> to record the change.</p> <p>As the response to the resource observation request contains actual <a href="https://tools.ietf.org/html/rfc7641#section-1.1" target="_blank" rel="noopener noreferrer">representation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, CoAP Gateway doesn't have to pull the data at all. Additional responses called <a href="https://tools.ietf.org/html/rfc7641#section-3.2" target="_blank" rel="noopener noreferrer">notifications<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are by the device send whenever the representation of the device changes.</p> <h4 id="resource-publish-subscription"><a href="#resource-publish-subscription" class="header-anchor">#</a> Resource Publish &amp; Subscription</h4> <br> <img src="https://www.plantuml.com/plantuml/svg/dT71Yi8m40RWUvvYw5LyWHuMYm6FYY0UFAN9R0suIKWcLQ4FxxHLMKKFUit_pVm3cILIaVBVGUojGVZrdcf_4YBmgzKsA4SWGIKe9BPMO_6Gp1VR8PlxQWKBHNXKvqUnhWQmnkHpr0XLqqHiM1P2I9Z-32ican9MkJxOj8URJA9F6F26rtb4oj7Tc2nXMIUCBK8OAHg8LooK9jjoAyY-TQmjxxlO1QReI97rxgbv4qm_6T_WwnbTrudTU4UbAVF4XwK6__blBfYXC_oH5m00" alt="Sequence"> <p>From this moment on, device is reachable to all authorized clients and devices. Resource update requests received by particular Gateway where the client is connected are forwarded to the <a href="#resource-aggregate">Resource Aggregate</a>. Successful command validation precede storing and publishing of this event to the <a href="#event-bus">Event Bus</a>, to which is the CoAP Gateway subscribed. If the update request event targets the device hosted by this instance of the CoAP Gateway, <a href="https://tools.ietf.org/html/rfc7252#section-5.8.2" target="_blank" rel="noopener noreferrer">UPDATE<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is forwarded over the authorized TCP channel to the device. Device response is forwarded to the <a href="#resource-aggregate">Resource Aggregate</a> which issues resource updated event updating the resource projection and informing client that the update was successful.</p> <h4 id="resource-update"><a href="#resource-update" class="header-anchor">#</a> Resource Update</h4> <br> <img src="https://www.plantuml.com/plantuml/svg/XPBBReCm44NtynKMsoZgdaKLC8XL9KHLPMti2LWYcFf1sx-lCT066gLBUyuTduiu6SkqTTSEMYcGN9IojVe46Fojv79WlIKPOOP46OwIOxIPqE8SPbGb9IcOnG_sjIMAXMYgajudgYG05HhbD4UID8t6nfDRB4y3be_e3wapEv4mV56rxFo6OOW0A3a-X-SFXvYy3S9l929qUEfaqrgYbnU1SIl7QKnXudtCE_sRyipHetaQazBLdJGjMJlCkGhV7HeRZ46ZTRe7ts8A-UyMFw9_ZOepqDafkrNQoyphrwbndACn5zUjuGU5Rk1bo_qwhp_Sx2XmOxaqA_ussmSthWBWXBtmF-0t" alt="Sequence"> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Client requesting resource observation will immediately start to receive notifications without additional request to the device over CoAP Gateway. As the plgd.cloud is by default observing resources of all connected devices, responsible Gateway will just subscribe to the <a href="#event-bus">Event Bus</a> and forward requested notifications. <strong>Handling of CRUDN operations is same for every Gateway.</strong></p></div> <h2 id="grpc-gateway"><a href="#grpc-gateway" class="header-anchor">#</a> gRPC Gateway</h2> <details class="custom-block details"><summary>gRPC Gateway Component Diagram</summary> <p><img src="/img/diagrams/component-grpcgateway.svg" alt="L3" width="600"></p></details> <h2 id="http-gateway"><a href="#http-gateway" class="header-anchor">#</a> HTTP Gateway</h2> <details class="custom-block details"><summary>HTTP Gateway Component Diagram</summary> <p><img src="/img/diagrams/component-httpgateway.svg" alt="L3" width="600"></p></details> <h2 id="resource-aggregate"><a href="#resource-aggregate" class="header-anchor">#</a> Resource Aggregate</h2> <p>Every transaction on the device's resource is scoped to the single <a href="https://martinfowler.com/bliki/DDD_Aggregate.html" target="_blank" rel="noopener noreferrer">aggregate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Resource Aggregate. The RA builds it's internal state, which is a projection of a single fine-grained event stream. When the aggregate receives a new command from any of the plgd gateway, the command is validated and after successful validation event describing the action is created and persisted in the <a href="#event-store">EventStore</a>. After successful write to the <a href="#event-store">EventStore</a>, event is published to the <a href="#event-bus">EventBus</a>.</p> <blockquote><p>To prevent the conflicts during the write to EventStore, <a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control" target="_blank" rel="noopener noreferrer">Optimistic concurrency control<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method is used</p></blockquote> <h3 id="commands-and-events-overview"><a href="#commands-and-events-overview" class="header-anchor">#</a> Commands and Events Overview</h3> <img src="https://www.plantuml.com/plantuml/svg/bTPFRu8m60RmUpz5ZtZm6nZZrDtCOjJTTkdeApH0IzhYiYpxxiFK4g7_c2SClpoyvVL9t2XDfEwQ6g4QhXfhWIKhIeqfav1h9ZXI5UCjaQJ1dOASAC0_2E7-ioLvLKZHSReJjP2h5Tw9fY6SulKQ7-ufsxe3GuMa8DFCINoz0TS3F07rn0rcJsHr9xy8sL6p4oZHoHm--4jHI2Y8XWKc2W_V4CgEtMVDL6dfWV5ABV1eK9IzytOEEu6M36vWbGDsWb-PREnzwrqdePzkRepHxj0j_KU8qOxQGmtpGunsr9lGxFezZ5iINW2TAfIDNkvZBmzdrpn1mrxYxCn9gqgXBwG27e1s5qVWbF4YeKAFCwk8PnWJIZ1xY2SO4qemIuWd61CynTE6tBjdtJyyyaf3dLfIySMNwwVs1NlbeMwtF2ZOBv-TT2mTPtlcEyYaQ-amspUFd7Ok7MPxvv61xhaI3PV3pL0Za_Ivbqay_Yd5-BIZSsnyW75VqpAUDkvkMiRJnZrEoyH97vkF6K-p4Thq0_J_4Vu0" alt="uml diagram"> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>More detailed flows which command triggers which event can be find directly in the <a href="https://github.com/plgd-dev/cloud/blob/v2/resource-aggregate/pb/commands.proto" target="_blank" rel="noopener noreferrer">commands proto file<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <details class="custom-block details"><summary>Resource Aggregate Component Diagram</summary> <p><img src="/img/diagrams/component-resourceaggregate.svg" alt="L3" width="600"></p></details> <h2 id="resource-directory"><a href="#resource-directory" class="header-anchor">#</a> Resource Directory</h2> <details class="custom-block details"><summary>Resource Directory Component Diagram</summary> <p><img src="/img/diagrams/component-resourcedirectory.svg" alt="L3" width="600"></p></details> <h2 id="device"><a href="#device" class="header-anchor">#</a> Device</h2> <details class="custom-block details"><summary>Device Component Diagram</summary> <p><img src="/img/diagrams/component-device.svg" alt="L3" width="600"></p></details> <h2 id="client"><a href="#client" class="header-anchor">#</a> Client</h2> <p>WIP<br>
https://openconnectivity.org/specs/OCF_Device_To_Cloud_Services_Specification_v2.2.1.pdf#page=31 8.1.2.2 OCF Cloud User Authorization of Mediator</p> <details class="custom-block details"><summary>Client Component Diagram</summary> <p><img src="/img/diagrams/component-clients.svg" alt="L3" width="600"></p></details> <h2 id="event-bus"><a href="#event-bus" class="header-anchor">#</a> Event Bus</h2> <p>After every successful write to the <a href="#event-store">EventStore</a>, an event is published on the event bus. Other plgd services are subscribed to the event bus to be notified when the change in the system / on the devices occurs or is requested. One such party is a resource directory, which aggregates resource models in memory for fast retrieve requested by the plgd gateways. Gateways are subscribed as well to be able to synchronously process device's resource updates.</p> <p>plgd cloud uses <a href="https://nats.io" target="_blank" rel="noopener noreferrer">NATS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> messaging system as it's event bus.</p> <blockquote><p>We are using pure NATS, not NATS Streaming nor Jetstream.</p></blockquote> <h2 id="event-store"><a href="#event-store" class="header-anchor">#</a> Event Store</h2> <p>plgd cloud persist events in an event store, which is a database of events. The store has an API for adding and retrieving device's events. Events needs to be versioned and written in a correct order. To achieve the consistency, optimistic concurrency control method is applied during each write.<br>
After the event is successfuly written into the event store, it's distributed to the event bus which notifies all subscribers about the change asynchronously.</p> <p>The plgd cloud defines an <a href="https://github.com/plgd-dev/cloud/blob/v2/resource-aggregate/cqrs/eventstore/eventstore.go#L23" target="_blank" rel="noopener noreferrer">EventStore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface what allows integration of different technologies to store the events. During the last 2 years the project evaluated multiple technologies for both EventStore and EventBus:</p> <ul><li>CockroachDB</li> <li>Apache Kafka</li> <li>MongoDB</li> <li>NATS Jetstream</li> <li>Google Firestore</li> <li>Amazon Kinesis</li></ul> <div class="custom-block tip"><p class="custom-block-title">Supported EvenStore</p> <p>Currently supported and preffered solution is MongoDB. Read further to know more about the database scheme and how we are Event Sourcing!</p></div> <h3 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h3> <p>Device's data are in the MongoDB organized per devices. For each connected device a new collection is created. Each event is modeled as a new document.</p> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>This model is now being evaluated by the MondoDB team and is likely to be improved in Q1-2021.</p></div> <h4 id="schema-overview"><a href="#schema-overview" class="header-anchor">#</a> Schema Overview</h4> <p><img src="/img/diagrams/mongodb-schema.png" alt="L3" width="600"></p> <h4 id="event-organization"><a href="#event-organization" class="header-anchor">#</a> Event Organization</h4> <p><img src="/img/diagrams/mongodb-eventsourcing.png" alt="L3" width="600"></p> <h4 id="queries"><a href="#queries" class="header-anchor">#</a> Queries</h4> <details class="custom-block details"><summary>Query resources B of device d9dd7...</summary> <ol><li>Get latest snapshot<br>
a. Find document <code>where _id == B.s</code><br>
b. Get <code>version</code> of latest snapshot event</li> <li>Find documents <code>where aggregateID == B &amp;&amp; version &gt;= latestSnapshot.version</code></li></ol></details> <details class="custom-block details"><summary>Query all resources of device d9dd7...</summary> <ol><li>Get latest snapshots of all resources<br>
a. Find documents <code>where aggregateID == snapshot &amp;&amp; version == -1</code><br>
b. Get <code>versions</code> of latest snapshot events per each resource</li> <li>Find all documents <strong>per each resource</strong> <code>where aggregateID == snapshot.aggregateID &amp;&amp; version &gt;= latestSnapshot.version</code></li></ol></details></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/plgd-dev/cloud/edit/v2/docs/guide/architecture/component-overview.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/14/2021, 2:31:33 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/architecture/system-overview.html" class="prev">
        System Overview
      </a></span> <span class="next"><a href="/guide/deployment/authorization-server.html">
        Authorization Server
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b9719399.js" defer></script><script src="/assets/js/2.e0060528.js" defer></script><script src="/assets/js/10.e2ff43d9.js" defer></script>
  </body>
</html>
